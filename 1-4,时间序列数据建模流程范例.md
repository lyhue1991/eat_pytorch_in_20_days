# 1-4,æ—¶é—´åºåˆ—æ•°æ®å»ºæ¨¡æµç¨‹èŒƒä¾‹


2020å¹´å‘ç”Ÿçš„æ–°å† è‚ºç‚ç–«æƒ…ç¾éš¾ç»™å„å›½äººæ°‘çš„ç”Ÿæ´»é€ æˆäº†è¯¸å¤šæ–¹é¢çš„å½±å“ã€‚

æœ‰çš„åŒå­¦æ˜¯æ”¶å…¥ä¸Šçš„ï¼Œæœ‰çš„åŒå­¦æ˜¯æ„Ÿæƒ…ä¸Šçš„ï¼Œæœ‰çš„åŒå­¦æ˜¯å¿ƒç†ä¸Šçš„ï¼Œè¿˜æœ‰çš„åŒå­¦æ˜¯ä½“é‡ä¸Šçš„ã€‚

æœ¬æ–‡åŸºäºä¸­å›½2020å¹´3æœˆä¹‹å‰çš„ç–«æƒ…æ•°æ®ï¼Œå»ºç«‹æ—¶é—´åºåˆ—RNNæ¨¡å‹ï¼Œå¯¹ä¸­å›½çš„æ–°å† è‚ºç‚ç–«æƒ…ç»“æŸæ—¶é—´è¿›è¡Œé¢„æµ‹ã€‚


![](./data/ç–«æƒ…å‰åå¯¹æ¯”.png)

```python
import os
import datetime
import importlib 
import torchkeras

#æ‰“å°æ—¶é—´
def printbar():
    nowtime = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    print("\n"+"=========="*8 + "%s"%nowtime)

#macç³»ç»Ÿä¸Špytorchå’Œmatplotlibåœ¨jupyterä¸­åŒæ—¶è·‘éœ€è¦æ›´æ”¹ç¯å¢ƒå˜é‡
os.environ["KMP_DUPLICATE_LIB_OK"]="TRUE" 

```

### ä¸€ï¼Œå‡†å¤‡æ•°æ®


æœ¬æ–‡çš„æ•°æ®é›†å–è‡ªtushareï¼Œè·å–è¯¥æ•°æ®é›†çš„æ–¹æ³•å‚è€ƒäº†ä»¥ä¸‹æ–‡ç« ã€‚

ã€Šhttps://zhuanlan.zhihu.com/p/109556102ã€‹

![](./data/1-4-æ–°å¢äººæ•°.png)


```python
import numpy as np
import pandas as pd 
import matplotlib.pyplot as plt

```

```python
%matplotlib inline
%config InlineBackend.figure_format = 'svg'

df = pd.read_csv("./data/covid-19.csv",sep = "\t")
df.plot(x = "date",y = ["confirmed_num","cured_num","dead_num"],figsize=(10,6))
plt.xticks(rotation=60);

```

![](./data/1-4-ç´¯ç§¯æ›²çº¿.png)

```python
dfdata = df.set_index("date")
dfdiff = dfdata.diff(periods=1).dropna()
dfdiff = dfdiff.reset_index("date")

dfdiff.plot(x = "date",y = ["confirmed_num","cured_num","dead_num"],figsize=(10,6))
plt.xticks(rotation=60)
dfdiff = dfdiff.drop("date",axis = 1).astype("float32")

```

![](./data/1-4-æ–°å¢æ›²çº¿.png)

```python
dfdiff.head()
```

![](./data/1-4-dfdiff.png)


ä¸‹é¢æˆ‘ä»¬é€šè¿‡ç»§æ‰¿torch.utils.data.Datasetå®ç°è‡ªå®šä¹‰æ—¶é—´åºåˆ—æ•°æ®é›†ã€‚

torch.utils.data.Datasetæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç”¨æˆ·æƒ³è¦åŠ è½½è‡ªå®šä¹‰çš„æ•°æ®åªéœ€è¦ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå¹¶ä¸”è¦†å†™å…¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•å³å¯ï¼š

* `__len__`:å®ç°len(dataset)è¿”å›æ•´ä¸ªæ•°æ®é›†çš„å¤§å°ã€‚
* `__getitem__`:ç”¨æ¥è·å–ä¸€äº›ç´¢å¼•çš„æ•°æ®ï¼Œä½¿`dataset[i]`è¿”å›æ•°æ®é›†ä¸­ç¬¬iä¸ªæ ·æœ¬ã€‚

ä¸è¦†å†™è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šç›´æ¥è¿”å›é”™è¯¯ã€‚


```python
import torch 
from torch import nn 
from torch.utils.data import Dataset,DataLoader,TensorDataset


#ç”¨æŸæ—¥å‰8å¤©çª—å£æ•°æ®ä½œä¸ºè¾“å…¥é¢„æµ‹è¯¥æ—¥æ•°æ®
WINDOW_SIZE = 8

class Covid19Dataset(Dataset):
        
    def __len__(self):
        return len(dfdiff) - WINDOW_SIZE
    
    def __getitem__(self,i):
        x = dfdiff.loc[i:i+WINDOW_SIZE-1,:]
        feature = torch.tensor(x.values)
        y = dfdiff.loc[i+WINDOW_SIZE,:]
        label = torch.tensor(y.values)
        return (feature,label)
    
ds_train = Covid19Dataset()

#æ•°æ®è¾ƒå°ï¼Œå¯ä»¥å°†å…¨éƒ¨è®­ç»ƒæ•°æ®æ”¾å…¥åˆ°ä¸€ä¸ªbatchä¸­ï¼Œæå‡æ€§èƒ½
dl_train = DataLoader(ds_train,batch_size = 38)
```

```python

```

### äºŒï¼Œå®šä¹‰æ¨¡å‹


ä½¿ç”¨Pytorché€šå¸¸æœ‰ä¸‰ç§æ–¹å¼æ„å»ºæ¨¡å‹ï¼šä½¿ç”¨nn.SequentialæŒ‰å±‚é¡ºåºæ„å»ºæ¨¡å‹ï¼Œç»§æ‰¿nn.ModuleåŸºç±»æ„å»ºè‡ªå®šä¹‰æ¨¡å‹ï¼Œç»§æ‰¿nn.ModuleåŸºç±»æ„å»ºæ¨¡å‹å¹¶è¾…åŠ©åº”ç”¨æ¨¡å‹å®¹å™¨è¿›è¡Œå°è£…ã€‚

æ­¤å¤„é€‰æ‹©ç¬¬äºŒç§æ–¹å¼æ„å»ºæ¨¡å‹ã€‚

ç”±äºæ¥ä¸‹æ¥ä½¿ç”¨ç±»å½¢å¼çš„è®­ç»ƒå¾ªç¯ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥å°†æ¨¡å‹å°è£…æˆtorchkerasä¸­çš„Modelç±»æ¥è·å¾—ç±»ä¼¼Kerasä¸­é«˜é˜¶æ¨¡å‹æ¥å£çš„åŠŸèƒ½ã€‚

Modelç±»å®é™…ä¸Šç»§æ‰¿è‡ªnn.Moduleç±»ã€‚


```python
import torch
from torch import nn 
import importlib 
import torchkeras 

torch.random.seed()

class Block(nn.Module):
    def __init__(self):
        super(Block,self).__init__()
    
    def forward(self,x,x_input):
        x_out = torch.max((1+x)*x_input[:,-1,:],torch.tensor(0.0))
        return x_out
    
class Net(nn.Module):
    def __init__(self):
        super(Net, self).__init__()
        # 3å±‚lstm
        self.lstm = nn.LSTM(input_size = 3,hidden_size = 3,num_layers = 5,batch_first = True)
        self.linear = nn.Linear(3,3)
        self.block = Block()
        
    def forward(self,x_input):
        x = self.lstm(x_input)[0][:,-1,:]
        x = self.linear(x)
        y = self.block(x,x_input)
        return y
        
net = Net()
model = torchkeras.Model(net)
print(model)

model.summary(input_shape=(8,3),input_dtype = torch.FloatTensor)
    
```

```
Net(
  (lstm): LSTM(3, 3, num_layers=5, batch_first=True)
  (linear): Linear(in_features=3, out_features=3, bias=True)
  (block): Block()
)
----------------------------------------------------------------
        Layer (type)               Output Shape         Param #
================================================================
              LSTM-1                 [-1, 8, 3]             480
            Linear-2                    [-1, 3]              12
             Block-3                    [-1, 3]               0
================================================================
Total params: 492
Trainable params: 492
Non-trainable params: 0
----------------------------------------------------------------
Input size (MB): 0.000092
Forward/backward pass size (MB): 0.000229
Params size (MB): 0.001877
Estimated Total Size (MB): 0.002197
----------------------------------------------------------------
```


### ä¸‰ï¼Œè®­ç»ƒæ¨¡å‹


è®­ç»ƒPytorché€šå¸¸éœ€è¦ç”¨æˆ·ç¼–å†™è‡ªå®šä¹‰è®­ç»ƒå¾ªç¯ï¼Œè®­ç»ƒå¾ªç¯çš„ä»£ç é£æ ¼å› äººè€Œå¼‚ã€‚

æœ‰3ç±»å…¸å‹çš„è®­ç»ƒå¾ªç¯ä»£ç é£æ ¼ï¼šè„šæœ¬å½¢å¼è®­ç»ƒå¾ªç¯ï¼Œå‡½æ•°å½¢å¼è®­ç»ƒå¾ªç¯ï¼Œç±»å½¢å¼è®­ç»ƒå¾ªç¯ã€‚

æ­¤å¤„ä»‹ç»ä¸€ç§ç±»å½¢å¼çš„è®­ç»ƒå¾ªç¯ã€‚

æˆ‘ä»¬ä»¿ç…§Keraså®šä¹‰äº†ä¸€ä¸ªé«˜é˜¶çš„æ¨¡å‹æ¥å£Model,å®ç° fit, validateï¼Œpredict, summary æ–¹æ³•ï¼Œç›¸å½“äºç”¨æˆ·è‡ªå®šä¹‰é«˜é˜¶APIã€‚

æ³¨ï¼šå¾ªç¯ç¥ç»ç½‘ç»œè°ƒè¯•è¾ƒä¸ºå›°éš¾ï¼Œéœ€è¦è®¾ç½®å¤šä¸ªä¸åŒçš„å­¦ä¹ ç‡å¤šæ¬¡å°è¯•ï¼Œä»¥å–å¾—è¾ƒå¥½çš„æ•ˆæœã€‚

```python
def mspe(y_pred,y_true):
    err_percent = (y_true - y_pred)**2/(torch.max(y_true**2,torch.tensor(1e-7)))
    return torch.mean(err_percent)

model.compile(loss_func = mspe,optimizer = torch.optim.Adagrad(model.parameters(),lr = 0.1))

```

```python
dfhistory = model.fit(100,dl_train,log_step_freq=10)
```

```python

```

### å››ï¼Œè¯„ä¼°æ¨¡å‹


è¯„ä¼°æ¨¡å‹ä¸€èˆ¬è¦è®¾ç½®éªŒè¯é›†æˆ–è€…æµ‹è¯•é›†ï¼Œç”±äºæ­¤ä¾‹æ•°æ®è¾ƒå°‘ï¼Œæˆ‘ä»¬ä»…ä»…å¯è§†åŒ–æŸå¤±å‡½æ•°åœ¨è®­ç»ƒé›†ä¸Šçš„è¿­ä»£æƒ…å†µã€‚

```python
%matplotlib inline
%config InlineBackend.figure_format = 'svg'

import matplotlib.pyplot as plt

def plot_metric(dfhistory, metric):
    train_metrics = dfhistory[metric]
    epochs = range(1, len(train_metrics) + 1)
    plt.plot(epochs, train_metrics, 'bo--')
    plt.title('Training '+ metric)
    plt.xlabel("Epochs")
    plt.ylabel(metric)
    plt.legend(["train_"+metric])
    plt.show()

```

```python
plot_metric(dfhistory,"loss")
```

![](./data/1-4-torchæŸå¤±æ›²çº¿.png)


### äº”ï¼Œä½¿ç”¨æ¨¡å‹


æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨æ¨¡å‹é¢„æµ‹ç–«æƒ…ç»“æŸæ—¶é—´ï¼Œå³ æ–°å¢ç¡®è¯Šç—…ä¾‹ä¸º0 çš„æ—¶é—´ã€‚

```python
#ä½¿ç”¨dfresultè®°å½•ç°æœ‰æ•°æ®ä»¥åŠæ­¤åé¢„æµ‹çš„ç–«æƒ…æ•°æ®
dfresult = dfdiff[["confirmed_num","cured_num","dead_num"]].copy()
dfresult.tail()
```

![](./data/1-4-æ—¥æœŸ3æœˆ10.png)

```python
#é¢„æµ‹æ­¤å200å¤©çš„æ–°å¢èµ°åŠ¿,å°†å…¶ç»“æœæ·»åŠ åˆ°dfresultä¸­
for i in range(200):
    arr_input = torch.unsqueeze(torch.from_numpy(dfresult.values[-38:,:]),axis=0)
    arr_predict = model.forward(arr_input)

    dfpredict = pd.DataFrame(torch.floor(arr_predict).data.numpy(),
                columns = dfresult.columns)
    dfresult = dfresult.append(dfpredict,ignore_index=True)
```

```python
dfresult.query("confirmed_num==0").head()

# ç¬¬50å¤©å¼€å§‹æ–°å¢ç¡®è¯Šé™ä¸º0ï¼Œç¬¬45å¤©å¯¹åº”3æœˆ10æ—¥ï¼Œä¹Ÿå°±æ˜¯5å¤©åï¼Œå³é¢„è®¡3æœˆ15æ—¥æ–°å¢ç¡®è¯Šé™ä¸º0
# æ³¨ï¼šè¯¥é¢„æµ‹åä¹è§‚
```

![](./data/1-4-torché¢„æµ‹ç¡®è¯Š.png)

```python

```

```python
dfresult.query("cured_num==0").head()

# ç¬¬132å¤©å¼€å§‹æ–°å¢æ²»æ„ˆé™ä¸º0ï¼Œç¬¬45å¤©å¯¹åº”3æœˆ10æ—¥ï¼Œä¹Ÿå°±æ˜¯å¤§æ¦‚3ä¸ªæœˆåï¼Œå³6æœˆ10æ—¥å·¦å³å…¨éƒ¨æ²»æ„ˆã€‚
# æ³¨: è¯¥é¢„æµ‹åæ‚²è§‚ï¼Œå¹¶ä¸”å­˜åœ¨é—®é¢˜ï¼Œå¦‚æœå°†æ¯å¤©æ–°å¢æ²»æ„ˆäººæ•°åŠ èµ·æ¥ï¼Œå°†è¶…è¿‡ç´¯è®¡ç¡®è¯Šäººæ•°ã€‚
```

![](./data/1-4-torché¢„æµ‹æ²»æ„ˆ.png)

```python
dfresult.query("dead_num==0").head()

# ç¬¬50å¤©å¼€å§‹æ–°å¢ç¡®è¯Šé™ä¸º0ï¼Œç¬¬45å¤©å¯¹åº”3æœˆ10æ—¥ï¼Œä¹Ÿå°±æ˜¯5å¤©åï¼Œå³é¢„è®¡3æœˆ15æ—¥æ–°å¢ç¡®è¯Šé™ä¸º0
# æ³¨ï¼šè¯¥é¢„æµ‹åä¹è§‚
```

![](./data/1-4-torché¢„æµ‹æ­»äº¡.png)

```python

```

### å…­ï¼Œä¿å­˜æ¨¡å‹


æ¨èä½¿ç”¨ä¿å­˜å‚æ•°æ–¹å¼ä¿å­˜Pytorchæ¨¡å‹ã€‚

```python
print(model.net.state_dict().keys())
```

```python
# ä¿å­˜æ¨¡å‹å‚æ•°

torch.save(model.net.state_dict(), "./data/model_parameter.pkl")

net_clone = Net()
net_clone.load_state_dict(torch.load("./data/model_parameter.pkl"))
model_clone = torchkeras.Model(net_clone)
model_clone.compile(loss_func = mspe)

# è¯„ä¼°æ¨¡å‹
model_clone.evaluate(dl_train)
```

```
{'val_loss': 4.254558563232422}
```

```python

```

**å¦‚æœæœ¬ä¹¦å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæƒ³é¼“åŠ±ä¸€ä¸‹ä½œè€…ï¼Œè®°å¾—ç»™æœ¬é¡¹ç›®åŠ ä¸€é¢—æ˜Ÿæ˜Ÿstarâ­ï¸ï¼Œå¹¶åˆ†äº«ç»™ä½ çš„æœ‹å‹ä»¬å–”ğŸ˜Š!** 

å¦‚æœå¯¹æœ¬ä¹¦å†…å®¹ç†è§£ä¸Šæœ‰éœ€è¦è¿›ä¸€æ­¥å’Œä½œè€…äº¤æµçš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨å…¬ä¼—å·"ç®—æ³•ç¾é£Ÿå±‹"ä¸‹ç•™è¨€ã€‚ä½œè€…æ—¶é—´å’Œç²¾åŠ›æœ‰é™ï¼Œä¼šé…Œæƒ…äºˆä»¥å›å¤ã€‚

ä¹Ÿå¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤å…³é”®å­—ï¼š**åŠ ç¾¤**ï¼ŒåŠ å…¥è¯»è€…äº¤æµç¾¤å’Œå¤§å®¶è®¨è®ºã€‚

![ç®—æ³•ç¾é£Ÿå±‹logo.png](./data/ç®—æ³•ç¾é£Ÿå±‹äºŒç»´ç .jpg)
